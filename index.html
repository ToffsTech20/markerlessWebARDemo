<!doctype html>
<html lang="en">
<head>
  <!-- Use Aframe version 1.1.0 : fix ascene not able to rotate after photo is taken -->
  <script src="https://aframe.io/releases/1.1.0/aframe.min.js"></script>
  <script src="https://hammerjs.github.io/dist/hammer.js"></script>
  <script src="./components/gesture-detector.js"></script>
  <script src="./components/gesture-handler.js"></script>
  <style>   
      #webcam {
          opacity:1;
          position: fixed;
          background-size: 100% 100%;
          top: 0; left: 0; 
          min-width: 100%; min-height: 100%;
          width: auto; height: auto;
      }
  </style>
</head>
<body>
  <div id="entireScene">
    <video autoplay id="webcam" playsinline></video>
    <a-scene 
      vr-mode-ui="enabled: false"
      gesture-detector>
      <a-sphere cursor-listener position="-7 0 7" radius="1.25" color="yellowgreen"></a-sphere>
      <a-sphere cursor-listener position="-7 0 -7" radius="1.25" color="green"></a-sphere>
      <a-entity
        id="cuteModel" 
        gltf-model="https://arjs-cors-proxy.herokuapp.com/https://raw.githubusercontent.com/martinLGH/AR/master/assets/cute.gltf" 
        scale="0.01 0.01 0.01" 
        position="10 -2 4" 
        rotation="0 270 0" 
        gesture-handler="minScale: 0.5; maxScale: 5; rotationFactor: 100;"
      ></a-entity>
      <a-entity 
        id="monsterModel" 
        gltf-model="./assets/monster.gltf" 
        scale="1 1 1" 
        position="10 -2 10" 
        rotation="0 270 0" 
        animation-mixer></a-entity>
    </a-scene>
  </div>

  <canvas id="canvas2"></canvas>

  <a id="saveAs" href="#">Click to download</a>

  <button onclick="stop();" style="position: absolute; left: 50px; top: 50px;">Switch Camera</button>

  <button onclick="takePhoto();" style="position: absolute; left: 50px; bottom: 50px;">Take Photo</button>
  

  <script>
    const video = document.querySelector('video');
    const canvas = document.getElementById('canvas2');
    const imgToCapture = document.getElementById('entireScene');
    // const position = video.getBoundingClientRect();
    const position = {
      width: 400,
      height: 300
    }
    canvas.width = position.width;
    canvas.height = position.height;

    let cameraDirection = "user"

    const startStream = async () => {
      if (cameraDirection === "user") {
        cameraDirection = "environment";
      } else if (cameraDirection === "environment") {
        cameraDirection = "user";
      }

      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: cameraDirection } });
      handleStream(stream);
    };

    const handleStream = (stream) => {
      video.srcObject = stream;
    };

    startStream();

    var stop = () => {
      console.log("stop button clicked");
      document.createElement('a');
      video.srcObject && video.srcObject.getTracks().forEach(t => t.stop());
      startStream();
    }

    var takePhoto = () => {
      console.log("photo is taken");
      var context = canvas.getContext('2d');
      context.drawImage(video, 0, 0, position.width, position.height);

      var canvas2 = document.querySelector('a-scene').components.screenshot.getCanvas('perspective');
      var context2 = canvas2.getContext('2d');
      context2.fillstyle = "RGB(0,0,0,0.1)";

      var image = new Image();
      image.onload = function () {

        context.drawImage(image, 0, 0, position.width, position.height);
        // let ctx = canvas.getContext('2d');
        // ctx.drawImage(video, 0, 0);
        
        // var link = document.getElementById('saveAs');
        // link.href = canvas.toDataURL();   /// set data-uri as href, defaults to PNG
        // link.download = 'myFilename.png';
        // link.click();
        // var canvas2 = AFRAME.scenes[0].canvas;
        // var image = canvas2.toDataURL("image/png").replace("image/png", "image/octet-stream"); 

        var link = document.createElement('a');
        link.href = canvas.toDataURL();   /// set data-uri as href, defaults to PNG
        link.download = 'myFilename.png';
        link.click();
      }

      console.log(context2);
      console.log(context2.canvas);

      image.src = context2.canvas.toDataURL("image/png");
    }

  </script>
</body>
</html>